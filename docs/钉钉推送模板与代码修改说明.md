# 钉钉推送模板与代码修改说明

---

## 1. 钉钉推送配置

配置文件：
- `ARL/docker/config-docker.yaml`
  - `DINGDING.SECRET`
  - `DINGDING.ACCESS_TOKEN`

推送底层：
- `ARL/app/helpers/message_notify.py` -> `push_dingding(markdown_report)`
- 内部调用：`ARL/app/utils/push.py` -> `dingding_send(...)`

说明：
- 当前使用 `msgtype="markdown"`。
- `errcode == 0` 视为成功。

---

## 2. 普通任务完成通知（可选）

### 开关字段
- API模型：`ARL/app/routes/task.py`
  - `dingding_notify`（bool）

### 触发入口
- 任务执行结束后调用：
  - `ARL/app/tasks/domain.py` -> `push_task_finish_notify(self.task_id)`
  - `ARL/app/tasks/ip.py` -> `push_task_finish_notify(self.task_id)`
  - `ARL/app/tasks/poc.py` -> `push_task_finish_notify(self.task_id)`

### 过滤条件
在 `ARL/app/helpers/message_notify.py` 的 `push_task_finish_notify(task_id)` 中：
- 任务状态必须是 `done`
- `task_tag` 仅支持普通任务/风险巡航
- `options.dingding_notify == True` 才推送
- `options.from_task_schedule == True` 时跳过（避免与计划任务重复推送）

### 模板修改位置
- `ARL/app/helpers/message_notify.py` -> `build_task_finish_markdown(task_data)`

如需改“普通任务通知文案/字段”，直接改这个函数。

---

## 3. 计划任务执行结果通知

### 通知配置字段
- `ARL/app/routes/task_schedule.py` 新建计划任务时保存：
  - `notify_enable`
  - `notify_channel`（当前仅 `dingding`）
  - `notify_on`（`finished | failed | always`）

### 执行链路
1. 计划任务触发提交子任务：`ARL/app/helpers/task_schedule.py` -> `submit_task_schedule(item)`
2. 子任务打标：`options["from_task_schedule"] = True`
3. 创建执行实例：`create_task_schedule_run(item, task_data_list)`
4. 调度轮询处理：`task_scheduler()` -> `process_task_schedule_runs()`
5. 满足条件后推送钉钉并更新 `push_status`

### 模板修改位置
- `ARL/app/helpers/task_schedule.py` -> `build_schedule_run_markdown(run_item)`

如需改“计划任务通知文案/字段”，直接改这个函数。

---

## 4. 后续扩展建议（继续对接钉钉 API）

如果要扩展更多能力（例如 @人、按钮卡片、文件链接等），建议按下面顺序改：

1. 统一扩展发送器  
   - 优先在 `ARL/app/helpers/message_notify.py` 增加新发送方法（例如 markdown + at 列表）。
2. 保持模板函数单一职责  
   - 普通任务改 `build_task_finish_markdown()`  
   - 计划任务改 `build_schedule_run_markdown()`
3. 渠道扩展点  
   - `ARL/app/routes/task_schedule.py` 放开 `notify_channel` 校验
   - `ARL/app/helpers/task_schedule.py` 的 `process_task_schedule_runs()` 增加新渠道分支
4. 幂等与重试  
   - 继续复用 `task_schedule_run.push_status` 避免重复推送
   - 失败可基于 `RUN_PUSH_ERROR` 增加重试策略

---

## 5. 快速检查清单

1. 配置检查：`DINGDING.SECRET`、`DINGDING.ACCESS_TOKEN` 是否生效。  
2. 普通任务：添加任务时是否勾选了 `钉钉通知`。  
3. 计划任务：`notify_enable` 是否开启、`notify_on` 条件是否匹配。  
4. 去重检查：计划任务子任务被标记 `from_task_schedule` 后，普通任务通知会跳过。  
5. 日志检查：关注 `push dingding succ` 与 push error 日志。  

---

## 6. GitHub 监控钉钉通知开关

### 新增字段
- `ARL/app/routes/github_scheduler.py`
  - 新增 `dingding_notify` 字段（bool）
  - 新建监控任务默认 `True`
  - 修改监控任务时可更新该字段

### 页面入口
- `GitHub监控 -> 添加任务`
  - 新增 `钉钉通知` 开关（默认开启）
  - 代码位置：`ARL/docker/frontend/js/pocList~31ecd969.eb252dc4.js`

### 执行判断
- `ARL/app/tasks/github.py` -> `GithubTaskMonitor.push_msg()`
  - 先调用 `enable_dingding_notify()`
  - 仅当开关为真时执行 `push_dingding()`
  - 历史任务兼容：字段缺失按开启处理
